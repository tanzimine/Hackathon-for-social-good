IMPORT $.IncomeVulnerability AS Income;

// Define the graph record structure
EXPORT GraphRec := RECORD
    STRING2   State;
    REAL8     Median_Income;
    REAL8     Vulnerability_Score;
    STRING20  Risk_Category;
    UNSIGNED4 Area_Count;
END;

// Prepare data for visualization
EXPORT GraphData := TABLE(Income.Scores,
    {STRING2   State := LEFT.State,
     REAL8     Median_Income := LEFT.Median_Income,
     REAL8     Vulnerability_Score := LEFT.Vulnerability_Score,
     STRING20  Risk_Category := IF(LEFT.Vulnerability_Score >= 80, 'High Risk',
                                IF(LEFT.Vulnerability_Score >= 40, 'Medium Risk',
                                   'Low Risk')),
     UNSIGNED4 Area_Count := COUNT(GROUP)},
    State);

// Output for visualization
OUTPUT(GraphData, NAMED('IncomeVulnerabilityGraph'));

// Additional statistics for the graph
EXPORT GraphStats := TABLE(GraphData,
    {REAL8     AvgIncome := AVE(GROUP, Median_Income),
     REAL8     AvgVulnerability := AVE(GROUP, Vulnerability_Score),
     UNSIGNED4 TotalAreas := SUM(GROUP, Area_Count),
     UNSIGNED4 HighRiskCount := COUNT(GROUP, Risk_Category = 'High Risk'),
     UNSIGNED4 MediumRiskCount := COUNT(GROUP, Risk_Category = 'Medium Risk'),
     UNSIGNED4 LowRiskCount := COUNT(GROUP, Risk_Category = 'Low Risk')},
    ALL);

OUTPUT(GraphStats, NAMED('GraphStatistics')); 